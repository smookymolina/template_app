{% extends "base.html" %}

{% block title %}Sistema de Gestión de Reclutas{% endblock %}

{% block content %}
<div id="login-section">
    <div class="login-card">
        <div class="card-header">
            <i class="fas fa-users-cog"></i>
            <h2>Sistema de Gestión de Reclutas</h2>
        </div>
        
        <div class="login-tabs">
            <button type="button" id="admin-login-tab" class="login-tab active">Administrador</button>
            <button type="button" id="tracking-tab" class="login-tab">Seguimiento</button>
        </div>
        
        <!-- ✅ PESTAÑA ADMINISTRADOR -->
        <form id="login-form" class="tab-content active">
            <div class="form-group">
                <label for="email">Correo Electrónico</label>
                <div class="input-icon-wrapper">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="email" placeholder="Tu correo electrónico" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="password">Contraseña</label>
                <div class="input-icon-wrapper">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="password" placeholder="Tu contraseña" required>
                    <button type="button" id="toggle-password" class="toggle-password"><i class="fas fa-eye"></i></button>
                </div>
            </div>
            
            <div class="remember-forgot">
                <label class="checkbox-container">
                    <input type="checkbox" id="remember-me">
                    <span class="checkbox-label">Recordarme</span>
                </label>
                <a href="#" class="forgot-password">¿Olvidaste tu contraseña?</a>
            </div>
            
            <button type="button" id="login-button" class="btn-primary">
                <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
            </button>
        </form>
        
        <!-- ✅ PESTAÑA SEGUIMIENTO PÚBLICO -->
        <div id="tracking-wrapper" class="tab-content">
            <!-- Formulario de consulta de folio -->
            <form id="tracking-form">
                <div class="form-group">
                    <label for="folio-input">Folio de Seguimiento</label>
                    <div class="input-icon-wrapper">
                        <i class="fas fa-file-alt"></i>
                        <input type="text" id="folio-input" placeholder="Ingresa tu folio (Ej: REC-1A2B3C4D)" required>
                    </div>
                </div>
                
                <p class="form-info">
                    <i class="fas fa-info-circle"></i> Ingresa el folio proporcionado para consultar el estado de tu proceso.
                </p>
                
                <div class="recovery-link-container">
                    <a href="#" id="tab-recuperar-folio-link">¿Olvidaste tu folio? Recupéralo aquí</a>
                </div>
                
                <button type="button" id="tracking-button" class="btn-primary">
                    <i class="fas fa-search"></i> Consultar Estado
                </button>
            </form>
            
            <!-- Contenedor para resultados del tracking -->
            <div id="tracking-results" style="display: none;">
                <!-- Los resultados se cargarán dinámicamente aquí -->
            </div>
        </div>
    </div>
</div>

<!-- ✅ MODAL DE CLIENTE PARA SEGUIMIENTO -->
<div id="cliente-modal" class="modal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h3>Seguimiento de Proceso</h3>
            <span class="close-modal">&times;</span>
        </div>

        <div class="modal-body">
            <!-- Formulario en el modal -->
            <form id="modal-tracking-form">
                <div class="form-group">
                    <label for="folio">Folio de Seguimiento</label>
                    <div class="input-icon-wrapper">
                        <i class="fas fa-file-alt"></i>
                        <input type="text" id="folio" placeholder="Ingresa tu folio (Ej: REC-1A2B3C4D)" required>
                    </div>
                </div>
                
                <div class="modal-info">
                    <i class="fas fa-info-circle"></i>
                    Ingresa el folio que recibiste para consultar el estado de tu proceso de reclutamiento.
                </div>
                
                <div class="recovery-link-container">
                    <a href="#" id="recuperar-folio-link">¿Olvidaste tu folio? Recupéralo aquí</a>
                </div>
            </form>
            
            <!-- Contenedor para resultados en el modal -->
            <div id="modal-results" style="display: none;">
                <!-- Los resultados se cargarán dinámicamente aquí -->
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-secondary close-modal-btn">
                <i class="fas fa-times"></i> Cerrar
            </button>
            <button type="button" class="btn-primary" id="consultar-folio-btn">
                <i class="fas fa-search"></i> Consultar Estado
            </button>
        </div>
    </div>
</div>

<!-- Dashboard Section (hidden by default) -->
<div id="dashboard-section" style="display: none;">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="profile-section">
            <div class="profile-pic-container">
                <img id="dashboard-profile-pic" class="profile-pic" src="/api/placeholder/100/100" alt="Foto de perfil">
                <div class="profile-pic-overlay">
                    <label for="profile-upload" class="profile-pic-edit">
                        <i class="fas fa-camera"></i>
                    </label>
                    <input type="file" id="profile-upload" accept="image/*" style="display: none;">
                </div>
            </div>
            <div class="profile-info">
                <h2 id="gerente-name">Nombre del Gerente</h2>
                <p class="profile-role">Administrador</p>
            </div>
        </div>
        
        <div class="dashboard-nav">
            <ul id="dashboard-navigation">
                <li class="active"><a href="#" data-section="reclutas-section"><i class="fas fa-users"></i> Reclutas</a></li>
                <li><a href="#" data-section="calendario-section"><i class="fas fa-calendar-alt"></i> Calendario</a></li>
                <li><a href="#" data-section="estadisticas-section"><i class="fas fa-chart-bar"></i> Estadísticas</a></li>
                <li><a href="#" data-section="configuracion-section"><i class="fas fa-cog"></i> Configuración</a></li>
            </ul>
        </div>
        
        <div class="profile-dropdown">
            <button id="profile-dropdown-button" class="profile-dropdown-button">
                <i class="fas fa-user-circle"></i>
                <span id="dropdown-user-name">Usuario</span>
                <i class="fas fa-chevron-down"></i>
            </button>
            <div id="profile-dropdown-content" class="dropdown-content">
                <a href="#" data-section="configuracion-section"><i class="fas fa-user-cog"></i> Mi Perfil</a>
                <a href="#"><i class="fas fa-question-circle"></i> Ayuda</a>
                <div class="dropdown-divider"></div>
                <a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
            </div>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
        <!-- Sección de reclutas -->
        {% include 'components/seccion_reclutas.html' %}
        
        <!-- Sección de calendario -->
        {% include 'components/seccion_calendario.html' %}
        
        <!-- Sección de estadísticas -->
        {% include 'components/seccion_estadisticas.html' %}
        
        <!-- Sección de configuración -->
        {% include 'components/seccion_configuracion.html' %}
    </div>
</div>
{% endblock %}

{% block modals %}
{% if include_components %}
<!-- Modales para la gestión de reclutas -->
{% include 'components/modals.html' %}

<!-- Modal de confirmación (usado en varias secciones) -->
<div id="confirm-modal" class="modal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h3 id="confirm-title">Confirmar acción</h3>
            <span class="close-modal">&times;</span>
        </div>

        <div class="modal-body">
            <p id="confirm-message">¿Estás seguro de que deseas realizar esta acción?</p>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-secondary close-modal">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button id="confirm-action-btn" class="btn-danger">
                <i class="fas fa-check"></i> Confirmar
            </button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="module">
    // ✅ IMPORTS CORRECTOS DE MÓDULOS
    import { showNotification, showError, showSuccess } from '/static/js/notifications.js';
    import Client from '/static/js/client.js';
    import Timeline from '/static/js/timeline.js';

    // ✅ INICIALIZACIÓN PRINCIPAL
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar módulo de cliente (tracking público)
        Client.init();
        
        // Inicializar timeline
        Timeline.init();
        
        // ✅ MANEJO DE PESTAÑAS CORREGIDO
        const adminLoginTab = document.getElementById('admin-login-tab');
        const trackingTab = document.getElementById('tracking-tab');
        const loginForm = document.getElementById('login-form');
        const trackingWrapper = document.getElementById('tracking-wrapper');

        if (adminLoginTab && trackingTab && loginForm && trackingWrapper) {
            adminLoginTab.addEventListener('click', function() {
                // Activar pestaña admin
                adminLoginTab.classList.add('active');
                trackingTab.classList.remove('active');
                loginForm.classList.add('active');
                trackingWrapper.classList.remove('active');
            });
            
            trackingTab.addEventListener('click', function() {
                // Activar pestaña seguimiento
                trackingTab.classList.add('active');
                adminLoginTab.classList.remove('active');
                trackingWrapper.classList.add('active');
                loginForm.classList.remove('active');
            });
        }

        // ✅ EVENTOS DE TRACKING EN LA PESTAÑA
        const trackingButton = document.getElementById('tracking-button');
        const folioInput = document.getElementById('folio-input');
        
        if (trackingButton) {
            trackingButton.addEventListener('click', function() {
                if (Client && typeof Client.processFolioValue === 'function') {
                    Client.processFolioValue(folioInput.value);
                }
            });
        }

        if (folioInput) {
            folioInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (Client && typeof Client.processFolioValue === 'function') {
                        Client.processFolioValue(this.value);
                    }
                }
            });
        }

        // ✅ LINK DE RECUPERAR FOLIO EN LA PESTAÑA
        const tabRecuperarFolioLink = document.getElementById('tab-recuperar-folio-link');
        if (tabRecuperarFolioLink) {
            tabRecuperarFolioLink.addEventListener('click', function(e) {
                e.preventDefault();
                // Abrir modal y mostrar formulario de recuperación
                const modal = document.getElementById('cliente-modal');
                if (modal) {
                    modal.style.display = 'block';
                    // Llamar función de recuperación del módulo Client
                    if (Client && typeof Client.showRecuperarFolioForm === 'function') {
                        setTimeout(() => Client.showRecuperarFolioForm(), 100);
                    }
                }
            });
        }

        // ✅ MODAL DE CLIENTE - EVENTOS
        const clienteModal = document.getElementById('cliente-modal');
        const consultarFolioBtn = document.getElementById('consultar-folio-btn');
        const folioModalInput = document.getElementById('folio');
        const recuperarFolioLink = document.getElementById('recuperar-folio-link');

        // Consultar folio en modal
        if (consultarFolioBtn) {
            consultarFolioBtn.addEventListener('click', function() {
                if (Client && typeof Client.processFolio === 'function') {
                    Client.processFolio();
                }
            });
        }

        // Enter en input del modal
        if (folioModalInput) {
            folioModalInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (Client && typeof Client.processFolio === 'function') {
                        Client.processFolio();
                    }
                }
            });
        }

        // Link recuperar folio en modal
        if (recuperarFolioLink) {
            recuperarFolioLink.addEventListener('click', function(e) {
                e.preventDefault();
                if (Client && typeof Client.showRecuperarFolioForm === 'function') {
                    Client.showRecuperarFolioForm();
                }
            });
        }

        // ✅ CERRAR MODAL
        const closeButtons = document.querySelectorAll('.close-modal, .close-modal-btn');
        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (clienteModal) {
                    clienteModal.style.display = 'none';
                    // Resetear formulario al cerrar
                    if (Client && typeof Client.resetFolioForm === 'function') {
                        Client.resetFolioForm();
                    }
                }
            });
        });

        // Cerrar modal al hacer clic fuera
        window.addEventListener('click', function(event) {
            if (event.target === clienteModal) {
                clienteModal.style.display = 'none';
                if (Client && typeof Client.resetFolioForm === 'function') {
                    Client.resetFolioForm();
                }
            }
        });

        // ✅ EXPONER FUNCIONES GLOBALMENTE PARA COMPATIBILIDAD
        window.showNotification = showNotification;
        window.showError = showError;
        window.showSuccess = showSuccess;
        window.Client = Client;
        window.Timeline = Timeline;
        
        console.log('✅ Sistema de tracking por folio inicializado correctamente');
    });
</script>

<!-- Input para Excel (si es necesario) -->
<input type="file" id="excel-file-input" accept=".xlsx,.xls" style="display: none;">
{% endblock %}